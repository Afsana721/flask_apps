<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AptiCraft • Products</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Three.js is optional now; page falls back to 2D if WebGL is unavailable -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <style>
    :root{--ink:#0b1223;--panel:#0e1a2b;--line:#1e2f47;--accent:#00d4ff;--accent2:#a3ff12}
    body{background:linear-gradient(180deg,#071423,#0b1223)}
    .card{background:linear-gradient(180deg,rgba(14,26,43,.85),rgba(14,26,43,.6));border:1px solid rgba(255,255,255,.08)}
    .badge{font-size:.625rem;padding:.15rem .4rem;border:1px solid rgba(255,255,255,.15);border-radius:.5rem}
  </style>
</head>
<body class="text-slate-200">
  <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <h1 class="text-3xl font-extrabold tracking-tight"><span class="text-[var(--accent)]">AptiCraft</span> Products</h1>
    <p class="text-slate-400 mt-1">Live simulation • 3×2 product grid • IDEs</p>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-20">
    {# Use DB rows if provided; fall back to 'products' or 'items' #}
    {% set rows = db_products|default(products)|default(items)|default([]) %}
    <!-- Row 1: Simulation on the left; first 3 products on the right -->
    <section class="max-w-5xl mx-auto">
  <!-- Centered Live Simulation -->
  <div class="card rounded-2xl p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-bold">Live Network Simulation</h2>
      <span id="simMode" class="badge text-slate-300">2D</span>
    </div>
    <div id="simCanvasWrap" class="h-[360px] rounded-xl overflow-hidden border border-white/10"></div>
  </div>
  <!-- Text summary of products (from DB) -->
  <div class="card rounded-2xl p-6 mt-6">
    <h3 class="text-lg font-bold mb-2">Products overview</h3>
    <p class="text-slate-300 text-sm mb-3">Below are six key products pulled from your database. Each card shows its image, category, and price; click <em>More view</em> for details.</p>
    <ul class="grid sm:grid-cols-2 gap-2 text-slate-300 text-sm">
      {% for p in rows[:6] %}
      <li>• <span class="font-semibold">{{ p.product_name }}</span> — {{ p.category }}</li>
      {% endfor %}
    </ul>
  </div>
</section>

    <!-- Row 2: Next 3 products (left) + IDEs (right) -->
    <!-- Two rows of three products -->
<section class="mt-6">
  <h2 class="sr-only">Products</h2>
  <div id="productsTop" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for p in rows[:3] %}
    <article class="rounded-xl border border-white/10 p-3 hover:border-white/20 transition">
      <div class="aspect-[4/3] bg-slate-900/40 rounded-lg overflow-hidden">
        <img src="{{ p.image_url or 'https://placehold.co/640x480/0B1223/00d4ff?text=Image' }}" alt="{{ p.product_name }}" class="w-full h-full object-cover"/>
      </div>
      <div class="mt-3 flex items-center justify-between gap-2">
        <div>
          <h3 class="font-semibold text-white line-clamp-1">{{ p.product_name }}</h3>
          <p class="text-xs text-slate-400">{{ p.category }}</p>
        </div>
        <div class="text-[var(--accent2)] font-extrabold">${{ '%.2f' % (p.price or 0) }}</div>
      </div>
      <div class="mt-3 flex gap-2">
        <button class="add-to-cart px-3 py-1.5 rounded-md bg-[var(--accent)] text-slate-900 text-sm font-semibold" data-id="{{ p.product_id }}">Add</button>
        <button class="px-3 py-1.5 rounded-md border border-slate-700 text-slate-200 text-sm" data-action="details"
        data-pid="{{ p.product_id }}"
        data-name="{{ p.product_name }}"
        data-category="{{ p.category }}"
        data-price="{{ '%.2f' % (p.price or 0) }}"
        data-img="{{ p.image_url }}"
        data-details="{{ p.details or 'More specifications and usage details coming soon.' }}">More view</button>
      </div>
    </article>
    {% endfor %}
  </div>
  <div id="productsBottom" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
    {% for p in rows[3:6] %}
    <article class="rounded-xl border border-white/10 p-3 hover:border-white/20 transition">
      <div class="aspect-[4/3] bg-slate-900/40 rounded-lg overflow-hidden">
        <img src="{{ p.image_url or 'https://placehold.co/640x480/0B1223/00d4ff?text=Image' }}" alt="{{ p.product_name }}" class="w-full h-full object-cover"/>
      </div>
      <div class="mt-3 flex items-center justify-between gap-2">
        <div>
          <h3 class="font-semibold text-white line-clamp-1">{{ p.product_name }}</h3>
          <p class="text-xs text-slate-400">{{ p.category }}</p>
        </div>
        <div class="text-[var(--accent2)] font-extrabold">${{ '%.2f' % (p.price or 0) }}</div>
      </div>
      <div class="mt-3 flex gap-2">
        <button class="add-to-cart px-3 py-1.5 rounded-md bg-[var(--accent)] text-slate-900 text-sm font-semibold" data-id="{{ p.product_id }}">Add</button>
        <button class="px-3 py-1.5 rounded-md border border-slate-700 text-slate-200 text-sm" data-action="details"
        data-pid="{{ p.product_id }}"
        data-name="{{ p.product_name }}"
        data-category="{{ p.category }}"
        data-price="{{ '%.2f' % (p.price or 0) }}"
        data-img="{{ p.image_url }}"
        data-details="{{ p.details or 'More specifications and usage details coming soon.' }}">More view</button>
      </div>
    </article>
    {% endfor %}
  </div>
</section>

<!-- IDEs moved below products -->
<section class="card rounded-2xl p-4 mt-6">
  <h2 class="text-xl font-bold mb-3">IDEs</h2>
  <div class="grid md:grid-cols-3 gap-4">
    <div class="rounded-xl border border-white/10 p-3">
      <h3 class="font-semibold mb-2">JS IDE</h3>
      
      <button id="run-js" class="mt-3 bg-[var(--accent)] text-slate-900 px-3 py-1.5 rounded font-semibold text-sm">Run</button>
      <pre id="js-out" class="mt-2 text-xs text-[var(--accent)]"></pre>
    </div>
    <div class="rounded-xl border border-white/10 p-3">
      <h3 class="font-semibold mb-2">DOM IDE</h3>
     
      <button id="run-dom" class="mt-3 bg-[var(--accent)] text-slate-900 px-3 py-1.5 rounded font-semibold text-sm">Run</button>
      <pre id="dom-out" class="mt-2 text-xs text-[var(--accent)]"></pre>
    </div>
    <div class="rounded-xl border border-white/10 p-3">
      <h3 class="font-semibold mb-2">SQL IDE <span class="text-xs text-slate-400">Preview</span></h3>
     
      <button id="run-sql" disabled class="mt-3 bg-slate-600/50 text-white px-3 py-1.5 rounded font-semibold text-sm cursor-not-allowed">Run</button>
      <pre id="sql-out" class="mt-2 text-xs text-[var(--accent)]">Wire to your route later.</pre>
    </div>
  </div>
</section>
    <!-- Product Details (hidden reveal) -->
  <section id="detailsPanel" class="card rounded-2xl p-6 mt-8 hidden">
    <div class="grid md:grid-cols-2 gap-6 items-start">
      <div>
        <img id="pdImg" src="" alt="" class="w-full aspect-[4/3] object-cover rounded-xl border border-white/10"/>
      </div>
      <div>
        <h3 id="pdName" class="text-2xl font-extrabold text-white"></h3>
        <p id="pdCat" class="text-slate-400 mt-1"></p>
        <p class="mt-3 text-[var(--accent2)] font-extrabold">$<span id="pdPrice"></span></p>
        <p id="pdText" class="mt-4 text-slate-300 leading-relaxed"></p>
        <div class="mt-6 flex gap-2">
          <button id="dpAdd" class="px-3 py-2 rounded-lg bg-[var(--accent)] text-slate-900 text-sm font-semibold" data-id="">Add to Cart</button>
          <button id="dpClose" class="px-3 py-2 rounded-lg bg-white/80 text-slate-900 text-sm">Hide</button>
        </div>
      </div>
    </div>
  </section>
</main>

  <!-- Quick View Modal -->
  <div id="quickModal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/70" data-close></div>
    <div class="relative card rounded-2xl w-full max-w-xl overflow-hidden">
      <div class="p-4 flex gap-4">
        <img id="modalImg" src="" alt="" class="w-40 h-28 object-cover rounded-lg border border-white/10"/>
        <div class="flex-1">
          <h3 id="modalName" class="text-xl font-bold text-white"></h3>
          <p id="modalCat" class="text-slate-400 text-sm mt-1"></p>
          <p class="mt-2 text-[var(--accent2)] font-bold">$<span id="modalPrice"></span></p>
          <div class="mt-4 flex gap-2">
            <button id="modalAdd" class="px-3 py-2 rounded-lg bg-[var(--accent)] text-slate-900 text-sm font-semibold" data-id="">Add to Cart</button>
            <button id="modalClose" class="px-3 py-2 rounded-lg bg-white/80 text-slate-900 text-sm" data-close>Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // --- Simulation: Live Network Topology (2D canvas; no WebGL) ---
(function(){
  var host = document.getElementById('simCanvasWrap'); if(!host) return;
  var modeEl = document.getElementById('simMode'); if(modeEl) modeEl.textContent='2D';
  var c = document.createElement('canvas'); c.style.display='block'; host.appendChild(c);
  var ctx = c.getContext('2d');
  function size(){ c.width = host.clientWidth; c.height = host.clientHeight; layout(); }
  if('ResizeObserver' in window){ new ResizeObserver(size).observe(host); } else { window.addEventListener('resize', size); }

  // --- Topology model ---
  var hubs = [], nodes = [], links = [], packets = [], mouse = {x:-1,y:-1};
  var HUBS = 5, SPOKES = 6;

  function layout(){
    nodes.length = 0; hubs.length = 0; links.length = 0; packets.length = 0;
    var W=c.width, H=c.height, pad=40;
    // hub positions (grid/ring hybrid)
    var hubPos = [
      [pad*2, H*0.25], [W*0.5, pad*1.6], [W-pad*2, H*0.28], [W*0.33, H*0.75], [W*0.75, H*0.70]
    ];
    for(var i=0;i<HUBS;i++){
      var h = {id:'H'+i, x: hubPos[i%hubPos.length][0], y: hubPos[i%hubPos.length][1], r: 8, type:'hub'};
      hubs.push(h); nodes.push(h);
      // spokes
      var radius = 70; var spokes = [];
      for(var s=0;s<SPOKES;s++){
        var ang = (Math.PI*2)*(s/SPOKES);
        var n = {id:'H'+i+'-S'+s, x: h.x + Math.cos(ang)*radius, y: h.y + Math.sin(ang)*radius, r: 3, type:'spoke'};
        nodes.push(n); spokes.push(n);
        links.push({a:h, b:n, back:false});
      }
    }
    // backbone ring between hubs
    for(var j=0;j<hubs.length;j++){
      var a=hubs[j], b=hubs[(j+1)%hubs.length];
      links.push({a:a,b:b, back:true});
    }
    // seed packets along links
    links.forEach(function(L,idx){
      var count = L.back? 6 : 2;
      for(var k=0;k<count;k++) packets.push({L:L, t: Math.random(), v: (L.back? 0.15:0.08) * (0.6+Math.random()*0.8)});
    });
  }

  // --- Interaction ---
  host.addEventListener('mousemove', function(e){
    var r = c.getBoundingClientRect(); mouse.x = e.clientX - r.left; mouse.y = e.clientY - r.top;
  });
  host.addEventListener('mouseleave', function(){ mouse.x = mouse.y = -1; });

  // --- Render loop ---
  var last=0; size();
  function loop(ts){
    var dt = Math.min(0.05, (ts-last)/1000 || 0.016); last = ts;
    ctx.clearRect(0,0,c.width,c.height);
    // bg
    ctx.fillStyle = '#0b1223'; ctx.fillRect(0,0,c.width,c.height);

    // draw links
    links.forEach(function(L){
      ctx.strokeStyle = L.back? 'rgba(0,212,255,.55)' : 'rgba(0,212,255,.35)';
      ctx.lineWidth = L.back? 1.6 : 1.0;
      ctx.beginPath(); ctx.moveTo(L.a.x, L.a.y); ctx.lineTo(L.b.x, L.b.y); ctx.stroke();
    });

    // animate packets along links
    packets.forEach(function(p){ p.t += p.v*dt; if(p.t>1) p.t-=1; });
    packets.forEach(function(p){
      var L=p.L, t=p.t; var x=L.a.x + (L.b.x-L.a.x)*t; var y=L.a.y + (L.b.y-L.a.y)*t;
      ctx.fillStyle = '#a3ff12';
      ctx.beginPath(); ctx.arc(x,y, L.back?2.2:1.8, 0, Math.PI*2); ctx.fill();
    });

    // draw nodes (highlight nearest hub)
    var hi=null, dmin=1e9; if(mouse.x>=0){
      hubs.forEach(function(h){ var dx=h.x-mouse.x, dy=h.y-mouse.y; var d=dx*dx+dy*dy; if(d<dmin){dmin=d; hi=h;} });
    }
    nodes.forEach(function(n){
      var isHub = n.type==='hub';
      ctx.fillStyle = isHub? '#00d4ff' : '#7dd3fc';
      if(hi && n===hi){ ctx.fillStyle='#38f8ff'; }
      ctx.beginPath(); ctx.arc(n.x,n.y, n.r*(isHub?1.3:1), 0, Math.PI*2); ctx.fill();
    });

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
  window.__sim = { mode: "2d" };
})();

// IDEs
  (function(){
    var rj=document.getElementById('run-js'), tj=document.getElementById('js-code'), oj=document.getElementById('js-out'); if(rj) rj.onclick=function(){ try{ oj.textContent=String(Function('return ('+tj.value+')')()); }catch(e){ oj.textContent=String(e);} };
    var rd=document.getElementById('run-dom'), td=document.getElementById('dom-code'), od=document.getElementById('dom-out'); if(rd) rd.onclick=function(){ try{ od.textContent='OK'; eval(td.value);}catch(e){ od.textContent=String(e);} };
  })();

  // Details reveal (populate hidden panel instead of modal)
  document.addEventListener('click',function(e){
    var b=e.target.closest('[data-action="details"]');
    if(b){
      var p=document.getElementById('detailsPanel');
      document.getElementById('pdImg').src=b.dataset.img||'';
      document.getElementById('pdName').textContent=b.dataset.name||'';
      document.getElementById('pdCat').textContent=b.dataset.category||'';
      document.getElementById('pdPrice').textContent=b.dataset.price||'0.00';
      document.getElementById('pdText').textContent=b.dataset.details||'More specifications and usage details coming soon.';
      document.getElementById('dpAdd').dataset.id=b.dataset.pid;
      p.classList.remove('hidden');
      p.scrollIntoView({behavior:'smooth', block:'start'});
    }
  });
  document.getElementById('dpClose')?.addEventListener('click', function(){
    document.getElementById('detailsPanel').classList.add('hidden');
  });

  // --- Smoke tests (run in Console) ---
  (function(){
    try {
      console.assert(document.getElementById('simCanvasWrap'), 'Sim container exists');
      console.assert(document.querySelectorAll('article').length >= 0, 'Product cards render (0+ allowed for empty DB)');
      console.assert(['webgl','2d'].includes((window.__sim||{}).mode||'2d'), 'Simulation mode set to webgl or 2d');
      console.info('Simulation mode:', (window.__sim||{}).mode);
    } catch(e){ console.warn('Smoke tests skipped:', e); }
  })();

 <!-- Add-to-Cart → JS/DOM trace + server roundtrip -->
     (function () {
    const outJS  = document.getElementById('js-out');
    const outDOM = document.getElementById('dom-out');
  
    // Utility loggers
    const logJS  = (o) => { if(outJS)  outJS.textContent  = JSON.stringify(o, null, 2) + "\n" + outJS.textContent; };
    const logDOM = (m) => { if(outDOM) outDOM.textContent = JSON.stringify(m, null, 2) + "\n" + outDOM.textContent; };
  
    // MutationObserver to capture DOM changes (cart badge, mini-cart, etc.)
    const applied = [];
    const mo = new MutationObserver((muts) => {
      muts.forEach(m => applied.push({ type: m.type, node: m.target?.tagName || '', attr: m.attributeName || null }));
    });
    mo.observe(document.body, { subtree: true, childList: true, attributes: true, characterData: false });
  
    // Delegated click handler for .add-to-cart
    document.addEventListener('click', async (e) => {
      const btn  = e.target.closest('.add-to-cart'); if (!btn) return;
      const card = btn.closest('article');
  
      // 1) SENT: event payload
      const payload = { product_id: Number(btn.dataset.id || 0) };
      logJS({ step: 'sent', event: 'click', payload, cardHTML: (card?.outerHTML || '').slice(0, 800) + '…' });
  
      // snapshot before (for quick diff)
      const before = { cart: document.getElementById('cart-count')?.textContent || null };
  
      // 2) REQUEST/RESPONSE
      try {
        const res  = await fetch('/api/cart/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        logJS({ step: 'response', ok: res.ok, status: res.status, data });
  
        // Optional UI update (only if you have #cart-count)
        if (res.ok && data.ok) {
          const badge = document.getElementById('cart-count');
          if (badge) badge.textContent = String((+badge.textContent || 0) + 1);
        }
      } catch (err) {
        logJS({ step: 'error', message: String(err) });
      } finally {
        // 3) DIFF + APPLIED
        const after = { cart: document.getElementById('cart-count')?.textContent || null };
        logJS({ step: 'diff', before, after });
        logDOM(applied.slice(-30)); // last mutations only
      }
    });
  })();
  </script>
</body>
</html>
