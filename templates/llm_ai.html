<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Farming Assistant: Integrated Intelligence</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Apply the Inter font globally for a modern, professional look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #040404;
            /* Very deep dark background */
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Custom gradient for titles and accents - BRIGHT VIOLET/BLUE */
        .gradient-accent {
            background: linear-gradient(90deg, #9D00FF, #00C2FF);
            /* Bright Violet to Electric Blue */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        /* Full screen canvas for 3D Background */
        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
        }

        /* Styling for the main content card */
        .content-card {
            background-color: rgba(17, 24, 39, 0.96);
            /* Deep dark blue-gray (Gray-900) */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }

        /* --- PILLAR CARD STYLING (The original pillars are replaced, but keeping this for other cards) --- */
        .pillar-card {
            /* Base style */
            padding: 1.5rem;
            border-radius: 1rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
            transform: translateY(0) scale(1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            min-height: 180px;
        }

        .pillar-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 0;
        }

        .pillar-card:hover::before,
        .pillar-card.active::before {
            opacity: 1;
            animation: pulse-glow 2s infinite alternate;
        }

        @keyframes pulse-glow {
            0% {
                transform: scale(0.9);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .pillar-card.active,
        .pillar-card:hover {
            transform: translateY(-5px) scale(1.02);
            /* More pronounced lift */
            background-color: rgba(31, 41, 55, 0.95);
            /* Slightly lighter dark background on hover */
        }

        /* Specific glow for active/hover state (Kept for completeness, though unused in the replaced section) */
        .pillar-card.green.active,
        .pillar-card.green:hover {
            border-color: #10B981;
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.7);
        }

        /* Emerald-500 */
        .pillar-card.pink.active,
        .pillar-card.pink:hover {
            border-color: #EC4899;
            box-shadow: 0 0 25px rgba(236, 72, 153, 0.7);
        }

        /* Pink-500 */
        .pillar-card.yellow.active,
        .pillar-card.yellow:hover {
            border-color: #FACC15;
            box-shadow: 0 0 25px rgba(252, 211, 77, 0.7);
        }

        /* Yellow-400 */
        .pillar-card.purple.active,
        .pillar-card.purple:hover {
            border-color: #A78BFA;
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.7);
        }

        /* Violet-400 */


        /* Inner Icon/Title Container */
        .pillar-content-header {
            position: relative;
            z-index: 10;
            /* Ensure text/icon is above glow */
        }

        /* Detail Text (Toggled Visibility) */
        .pillar-detail {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            /* Bouncier transition */
            margin-top: 0;
            padding-top: 0;
            position: relative;
            z-index: 10;
        }

        .pillar-card.active .pillar-detail {
            max-height: 200px;
            opacity: 1;
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            border-top: 1px solid rgba(156, 163, 175, 0.25);
        }

        /* --- INTERACTIVE WORKFLOW STYLING --- */
        .workflow-step-btn {
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            position: relative;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 700;
            color: #E2E8F0;
            /* Light gray text for inactive */
            background-color: #374151;
            /* Gray-700 for inactive */
            border: 1px solid transparent;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .workflow-step-btn:hover:not(.active) {
            background-color: #4B5563;
            /* Darker gray on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .workflow-step-btn.active {
            box-shadow: 0 0 20px rgba(157, 0, 255, 0.7);
            /* Electric Violet glow */
            transform: scale(1.05);
            background: linear-gradient(90deg, #9D00FF, #00C2FF);
            /* Gradient background for active */
            color: #111827;
            /* Dark text for contrast */
            border-color: #00C2FF;
        }

        .step-content {
            min-height: 280px;
            /* Slightly more space */
            opacity: 0;
            transform: translateY(10px);
            /* Initial subtle slide */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .step-content.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .visualization-box {
            background-color: #0D1016;
            /* Even darker for code/viz */
            border: 1px solid #9D00FF;
            /* Electric Violet border */
            box-shadow: 0 0 15px rgba(157, 0, 255, 0.4);
            transition: all 0.3s ease;
        }

        /* --- NEW: Pipeline Component Card Styles --- */
        .pipeline-card {
            background-color: #1F2937;
            /* Gray-800 */
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .pipeline-card:hover {
            transform: translateY(-3px);
            background-color: #2D3748;
            border-color: #00C2FF;
            /* Electric Blue on hover */
            box-shadow: 0 0 15px rgba(0, 194, 255, 0.4);
        }

        .pipeline-card.active {
            border-color: #9D00FF;
            /* Electric Violet when active */
            box-shadow: 0 0 15px rgba(157, 0, 255, 0.7);
        }

        .pipeline-number {
            font-size: 12px;
            font-weight: 800;
            line-height: 1;
            color: #9D00FF;
            /* Electric Violet */
            margin-right: 0.25rem;
        }

        .pipeline-name {
            font-size: 13px;
            font-weight: 200;
            color: #ffffff;
        }

        .pipeline-type {
            font-size: 0.50rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            background-color: #00C2FF30;
            /* Semi-transparent blue */
            color: #00C2FF;
            white-space: nowrap;
        }

        .pipeline-detail {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.4s ease-in-out;
            margin-top: 0;
            padding-top: 0;
            color: #CBD5E1;
        }

        .pipeline-card.active .pipeline-detail {
            max-height: 100px;
            /* Enough height for the content */
            opacity: 1;
            padding-top: 0.75rem;
            margin-top: 0.5rem;
            border-top: 1px dashed rgba(156, 163, 175, 0.3);
        }

        .control-btn {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.2s;
        }

        /* --- VISUALIZATION MODULE STYLES (New Section) --- */
        #llm-visualization-module {
            background-color: #111827;
            /* bg-gray-900 */
            color: #F9FAFB;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border-radius: 0.75rem;
            /* rounded-xl */
        }

        /* Style for the text labels on the canvas */
        .label {
            position: absolute;
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            pointer-events: none;
            /* Make sure labels don't block mouse interaction with canvas */
            text-shadow: 0 0 5px black;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
            /* Ensure labels are above the canvas */
            white-space: nowrap;
        }

        /* Ensure the canvas container fills its parent and relative positioning works for labels */
        #canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* Ensure the actual canvas element fits its container */
        #canvas-container canvas {
            display: block;
        }
    </style>
</head>

<body>

    <div class="content-card w-full max-w-7xl mx-auto p-6 md:p-12 rounded-3xl shadow-2xl relative z-10 my-8">

        <header class="text-center mb-12">
            <img src="{{ url_for('static', filename='aptiCraft.png') }}" alt="apticraft" class="mx-auto mb-4 w-16 h-16">
            <span class="text-3xl font-extrabold text-emerald-400 mb-8">AptiCraft</span>
            <h1 class="text-xs font-semibold uppercase tracking-widest text-violet-400 mb-3 mt-4">
                AUTONOMOUS SYSTEM ARCHITECTURE
            </h1>
            <h2 class="text-3xl sm:text-4xl font-800 leading-tight gradient-accent ">
                AI FARMING ASSISTANT
            </h2>
            <p class="mt-4 text-xl text-gray-300 max-w-4xl mx-auto">
                Integrated intelligence stack, designed for seamless communication from natural language to field
                execution.
            </p>
        </header>

        <!-- 
            ===============================================================
            START OF THE NEW VISUALIZATION SECTION (Replacing "Four Pillars")
            ===============================================================
        -->
        <section id="llm-visualization-module"
            class="w-full max-w-full h-auto mx-auto p-8 bg-gray-900/70 rounded-2xl border border-gray-800 mb-12"
            style="min-height: 500px;">

            <!-- Content Structure -->
            <div class="w-full h-full flex flex-col items-center justify-center p-0 md:p-0">

                <h4 class="text-2xl sm:text-3xl font-bold leading-tight text-[#046DBB] text-center mb-8">
                    Deep Data Integration: LLM Development Core
                </h4>
                <p class="text-xl md:text-xl font-light text-gray-300 mb-6 text-center">
                    Visualizing the flow of multi-modal farm data into the centralized AI processing unit.
                </p>

                <!-- The simulation visual area -->
                <div id="simulation-visual-area"
                    class="w-full max-w-5xl h-[430px] rounded-xl shadow-2xl shadow-purple-500/20 relative border border-gray-700 bg-black">
                    <!-- The canvas will be inserted here by three.js -->
                    <div id="canvas-container" class="w-full h-full"></div>

                    <!-- Text labels for the simulation -->
                    <div class="label" style="top: 15%; left: 10%;">Satellite & Drone Imagery (Web Data)</div>
                    <div class="label" style="top: 20%; right: 10%;">Soil & Climate Sensor Data</div>
                    <div class="label" style="bottom: 25%; left: 15%;">Historical Farm ERP Data</div>
                    <div class="label"
                        style="top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1rem; padding: 8px 12px; background: rgba(157, 0, 255, 0.8);">
                        LLM Processing Core (The Brain)</div>
                    <div class="label" style="bottom: 10%; right: 10%;">Actionable Robotic Commands</div>
                </div>
            </div>
        </section>

        <!-- 
            ===============================================================
            END OF THE NEW VISUALIZATION SECTION
            ===============================================================
        -->
        <!-- NEW SECTION: Interactive Query Pipeline graphs image -->
        <!-- NEW SECTION: Interactive Query Pipeline graphs image -->
        <section class="p-8 bg-gray-900/70 rounded-2xl border border-gray-800 mb-12">
            <h4 class="text-3xl sm:text-2xl font-extrabold leading-tight text-[#00BCD4] text-center mb-8">
                Agents, LLMs, RAG, Fine-tuning, LangChain with practical examples to start building
            </h4>
            <div class="max-w-xl mx-auto">
                <img src="https://towardsdatascience.com/wp-content/uploads/2025/05/mind_map_final2-1-1536x815.jpg"
                    alt="LLM Query image" class="w-full h-auto rounded-xl shadow-lg border-4 border-[#090979]">
            </div>
        </section>

        <!-- NEW SECTION: Agents → LLMs — Short, Clear Gist (no “what is”) -->
        <section class="p-8 bg-gray-900/60 rounded-2xl border border-gray-800 mb-12 text-[#00BCD4]">
            <h4 class="text-2xl font-bold text-white mb-4 text-center">Agents → LLMs</h4>
            <div class="max-w-3xl mx-auto space-y-4 leading-relaxed text-gray-100/90">
                <p><span class="font-semibold">Agent</span>: decides next step toward a goal and <em>acts</em>. Three
                    parts — <span class="font-semibold">model</span> (language/reasoning), <span
                        class="font-semibold">instructions</span> (goals, rules, memory), <span
                        class="font-semibold">tools</span> (functions/APIs, data). Loop: observe → plan → call tools →
                    act → repeat.</p>
                <p><span class="font-semibold">Uses an LLM</span> for language + reasoning. The model proposes plans,
                    function calls, and responses; tools (search, DB, code) return real data. For documents, add <span
                        class="font-semibold">RAG</span> to retrieve your own content and ground answers.</p>
                <p><span class="font-semibold">LLM</span>: next‑token predictor you control via <span
                        class="font-semibold">prompts</span>. Add <span class="font-semibold">RAG</span> for facts; use
                    <span class="font-semibold">fine‑tuning</span> only when stable tone/behavior must live inside the
                    model.</p>
                <p><span class="font-semibold">Ship</span>: evaluate quality, latency, and cost; use guardrails to limit
                    hallucinations.</p>
                <p class="text-gray-100/80">Agents rely on data returned by LLMs and tools to refine each action step.
                    This loop continues until the defined goal is achieved.</p>
                <p class="text-gray-100/80">LLMs act as the brain inside the agent—interpreting context, generating
                    reasoning, and shaping actions with retrieved knowledge.</p>
                <p class="text-gray-100/80">Together they form the core of modern AI pipelines, combining autonomy with
                    real-world data access.</p>
            </div>
            <div class="text-center mt-6">
                <a href="https://towardsdatascience.com/new-to-llms-start-here/" target="_blank" rel="noopener"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-purple-700 text-black rounded-lg border-2 border-white/80 hover:border-white/40">
                    Read more at Towards Data Science →
                </a>
            </div>
        </section>


        <section class="p-8 bg-gray-900/70 rounded-2xl border border-gray-800 mb-12">
            <h4 class="text-3xl sm:text-3xl font-extrabold leading-tight text-[#710FA6] text-center mb-8">
                Interactive Query Pipeline- Language to Action
            </h4>
            <div class="flex flex-wrap justify-center space-x-2 md:space-x-4 mb-8">
                <button class="workflow-step-btn active bg-violet-500 text-white" data-step="1" onclick="showStep(1)">1.
                    User Input</button>
                <button class="workflow-step-btn bg-gray-700 text-gray-300" data-step="2" onclick="showStep(2)">2.
                    Orchestration (LLM)</button>
                <button class="workflow-step-btn bg-gray-700 text-gray-300" data-step="3" onclick="showStep(3)">3. Data
                    Retrieval (RAG)</button>
                <button class="workflow-step-btn bg-gray-700 text-gray-300" data-step="4" onclick="showStep(4)">4.
                    Prediction & Planning</button>
                <button class="workflow-step-btn bg-gray-700 text-gray-300" data-step="5" onclick="showStep(5)">5.
                    Autonomous Execution</button>
            </div>


            <div id="workflow-content" class="bg-gray-800 rounded-xl p-6 border border-violet-500/30 relative fade-in">
            </div>
        </section>
        <!-- NEW SECTION: 14-Step AI Q->A Pipeline -->
        <section class="p-8 bg-gray-900/70 rounded-2xl border border-gray-800">
            <h4 class="text-xl sm:text-2xl font-extrabold leading-tight text-[#00BCD4] text-center mb-6">
                Deep Dive-14-Step AI Q→A Pipeline
            </h4>

            <!-- Controls -->
            <div class="flex justify-center space-x-4 mb-8 text-sm">
                <button class="control-btn bg-[#0E3386] text-white hover:bg-[#000080]"
                    onclick="toggleAllPipelineDetails(true)">Open All</button>
                <button class="control-btn bg-[#6F00FF] text-white hover:bg-[#4B0082]"
                    onclick="toggleAllPipelineDetails(false)">Close All</button>
            </div>

            <!-- Pipeline Grid -->
            <div id="pipeline-grid" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-5 gap-2">

                <!-- Content injected by JavaScript -->
            </div>
        </section>


        <!-- LLM Animated Flowchart (added above Pipeline) -->
        <section id="animated-flow" class="max-w-3xl mx-auto p-2">
            <div
                class="rounded-2xl border border-cyan-900/50 bg-[#0f141b] p-2 shadow-[0_10px_30px_rgba(0,255,255,0.15)]">
                <h1 class="text-2xl font-bold text-white mb-2 text-center">LLM Decision Flow Animator</h1>
                <p class="text-cyan-300/80 mb-4 text-center text-sm">Data flow runs automatically. Drag nodes to
                    reorganize.</p>
                <div
                    class="relative w-full max-w-xl mx-auto h-44 sm:h-52 md:h-60 border border-cyan-700/50 rounded-lg overflow-hidden">
                    <svg id="flowchart-svg" width="100%" height="100%" viewBox="0 0 700 400"
                        preserveAspectRatio="xMidYMid meet" class="block">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#4b5563" />
                            </marker>
                        </defs>
                    </svg>
                </div>
                <p id="status-message" class="text-xs text-cyan-400 font-semibold mt-3 text-center">Flow Active: Data
                    Packets Moving...</p>
            </div>

            <style>
                #animated-flow .node-circle {
                    transition: stroke .3s, fill .3s, transform .2s;
                    stroke-width: 3;
                    filter: drop-shadow(0 0 5px rgba(0, 0, 0, .5))
                }

                #animated-flow .node-label {
                    font-size: 10px;
                    fill: #e5e7eb;
                    user-select: none
                }

                #animated-flow .edge-path {
                    stroke-width: 1.5;
                    stroke: #4b5563;
                    fill: none;
                    marker-end: url(#arrowhead)
                }

                #animated-flow .flow-marker {
                    fill: #00ffff;
                    animation: flow-pulse .5s infinite alternate;
                    pointer-events: none
                }

                @keyframes flow-pulse {
                    from {
                        transform: scale(1);
                        opacity: .8
                    }

                    to {
                        transform: scale(1.5);
                        opacity: 1
                    }
                }

                @keyframes node-activate {
                    0% {
                        transform: scale(1)
                    }

                    50% {
                        transform: scale(1.15);
                        fill: #00ffff
                    }

                    100% {
                        transform: scale(1)
                    }
                }

                #animated-flow .activated {
                    animation: node-activate .3s ease-out
                }

                #animated-flow g.node-container {
                    cursor: grab
                }

                #animated-flow g.node-container:active {
                    cursor: grabbing
                }
            </style>

            <script>
                (function () {
                    const NODE_RADIUS = 16, FLOW_SPEED = 2000, FLOW_MARKER_SIZE = 3;
                    const svg = document.getElementById('flowchart-svg');
                    const statusMessage = document.getElementById('status-message');
                    const nodes = [
                        { id: 'start', label: 'QEvent', x: 100, y: 200, color: '#9333ea' },
                        { id: 'start2', label: 'Start', x: 200, y: 200, color: '#3b82f6' },
                        { id: 'predict', label: 'Pending_Predict', x: 350, y: 100, color: '#10b981' },
                        { id: 'decision', label: 'Trading_Decision', x: 500, y: 200, color: '#f59e0b' },
                        { id: 'feedback', label: 'Offline/Online Feedback', x: 400, y: 330, color: '#10b981' },
                        { id: 'trade', label: 'TradeEvent', x: 650, y: 200, color: '#f87171' }
                    ];
                    const edges = [
                        { id: 'e1', source: 'start', target: 'start2' },
                        { id: 'e2', source: 'start2', target: 'predict' },
                        { id: 'e3', source: 'predict', target: 'decision' },
                        { id: 'e4', source: 'decision', target: 'trade' },
                        { id: 'e6', source: 'decision', target: 'feedback' },
                        { id: 'e7', source: 'feedback', target: 'decision' }
                    ];
                    const nodeEls = {};
                    function draw() {
                        Array.from(svg.querySelectorAll('g.node-container, path.edge-path')).forEach(el => el.remove());
                        // edges
                        edges.forEach(e => {
                            const s = nodes.find(n => n.id === e.source), t = nodes.find(n => n.id === e.target);
                            let d;
                            if (e.id === 'e7') {
                                const c1x = t.x - 150, c1y = t.y + 10, c2x = s.x + 50, c2y = s.y + 50;
                                d = `M ${s.x} ${s.y} C ${c2x} ${c2y}, ${c1x} ${c1y}, ${t.x} ${t.y}`;
                            } else {
                                d = `M ${s.x} ${s.y} L ${t.x} ${t.y}`;
                            }
                            const p = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            p.setAttribute('d', d); p.classList.add('edge-path'); p.id = `path-${e.id}`; svg.appendChild(p);
                        });
                        // nodes
                        nodes.forEach(n => {
                            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                            g.classList.add('node-container'); g.id = `node-${n.id}`; g.dataset.id = n.id; g.setAttribute('transform', `translate(${n.x},${n.y})`);
                            const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                            c.classList.add('node-circle'); c.setAttribute('r', NODE_RADIUS); c.setAttribute('fill', '#1f2937'); c.setAttribute('stroke', n.color); g.appendChild(c);
                            const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            t.classList.add('node-label'); t.setAttribute('text-anchor', 'middle'); t.setAttribute('alignment-baseline', 'middle'); t.setAttribute('y', 2); t.textContent = n.label; g.appendChild(t);
                            svg.appendChild(g); nodeEls[n.id] = g;
                        });
                    }
                    function pulse(id) { const g = nodeEls[id]; if (!g) return; const c = g.querySelector('.node-circle'); c.classList.add('activated'); setTimeout(() => c.classList.remove('activated'), 300); }
                    function animateEdge(id) {
                        const path = document.getElementById(`path-${id}`); if (!path) return; const len = path.getTotalLength();
                        const m = document.createElementNS('http://www.w3.org/2000/svg', 'circle'); m.classList.add('flow-marker'); m.setAttribute('r', FLOW_MARKER_SIZE); svg.appendChild(m);
                        let t0; function step(ts) {
                            if (!t0) t0 = ts; const prog = ((ts - t0) % FLOW_SPEED) / FLOW_SPEED; const pt = path.getPointAtLength(prog * len); m.setAttribute('cx', pt.x); m.setAttribute('cy', pt.y);
                            if (prog > .98) { const e = edges.find(x => `path-${x.id}` === path.id); if (e) pulse(e.target); }
                            requestAnimationFrame(step);
                        } requestAnimationFrame(step);
                    }
                    function enableDrag() {
                        function getSVGPoint(clientX, clientY) { const CTM = svg.getScreenCTM(); return { x: (clientX - CTM.e) / CTM.a, y: (clientY - CTM.f) / CTM.d }; }
                        let active = null, off = { x: 0, y: 0 };
                        Object.values(nodeEls).forEach(g => {
                            g.addEventListener('mousedown', e => { active = g; g.style.cursor = 'grabbing'; const id = g.dataset.id; const n = nodes.find(x => x.id === id); const p = getSVGPoint(e.clientX, e.clientY); off.x = p.x - n.x; off.y = p.y - n.y; });
                        });
                        document.addEventListener('mousemove', e => { if (!active) return; const id = active.dataset.id; const n = nodes.find(x => x.id === id); const p = getSVGPoint(e.clientX, e.clientY); n.x = p.x - off.x; n.y = p.y - off.y; active.setAttribute('transform', `translate(${n.x},${n.y})`); redrawEdges(); });
                        document.addEventListener('mouseup', () => { if (active) { active.style.cursor = 'grab'; active = null; } });
                    }
                    function redrawEdges() { edges.forEach(e => { const path = document.getElementById(`path-${e.id}`); if (!path) return; const s = nodes.find(n => n.id === e.source), t = nodes.find(n => n.id === e.target); let d; if (e.id === 'e7') { const c1x = t.x - 150, c1y = t.y + 10, c2x = s.x + 50, c2y = s.y + 50; d = `M ${s.x} ${s.y} C ${c2x} ${c2y}, ${c1x} ${c1y}, ${t.x} ${t.y}`; } else { d = `M ${s.x} ${s.y} L ${t.x} ${t.y}`; } path.setAttribute('d', d); }); }
                    function start() { draw(); enableDrag();['e1', 'e2', 'e3', 'e4', 'e6', 'e7'].forEach((id, i) => setTimeout(() => animateEdge(id), i * 150)); statusMessage.textContent = 'Flow Active: Data Packets Moving...'; }
                    start();
                })();
            </script>
        </section>

        <section id="llm-sim" class="max-w-5xl mx-auto p-6">
            <div class="rounded-2xl border border-slate-700 bg-[#081f37] p-6 shadow-xl text-[#F5F5F5]">
                <header class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-[#6222C3] p-2 ">LLM Data Pipeline simulation</h2>
                </header>

                <div id="pipeline-grid"
                    class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 text-xs">
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">1.
                        AI (Agent)<span class="ml-1 text-[10px] font-mono opacity-80">◉</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">2.
                        Ingest (Cleaner)<span class="ml-1 text-[10px] font-mono opacity-80">⟲</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">3.
                        Chunk (Cutter)<span class="ml-1 text-[10px] font-mono opacity-80">✂</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">4.
                        Embed (to numbers)<span class="ml-1 text-[10px] font-mono opacity-80">⊕</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">5.
                        Index (Vector DB)<span class="ml-1 text-[10px] font-mono opacity-80">⧉</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">6.
                        NLP (Listener)<span class="ml-1 text-[10px] font-mono opacity-80">☊</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">7.
                        RAG (Retriever)<span class="ml-1 text-[10px] font-mono opacity-80">⌁</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">8.
                        ToolPlan (Planner)<span class="ml-1 text-[10px] font-mono opacity-80">⌖</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">9.
                        Execute (Worker)<span class="ml-1 text-[10px] font-mono opacity-80">⚙</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">10.
                        ComposePrompt (Packager)<span class="ml-1 text-[10px] font-mono opacity-80">✉</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">11.
                        LLM (Writer)<span class="ml-1 text-[10px] font-mono opacity-80">✎</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">12.
                        Post‑Process (Checker)<span class="ml-1 text-[10px] font-mono opacity-80">✓</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">13.
                        Return (Messenger)<span class="ml-1 text-[10px] font-mono opacity-80">⤴</span></span>
                    <span
                        class="p-3 leading-snug rounded tracking-tight bg-[#081f37] border border-slate-600 text-center">14.
                        Learn Loop (Improver)<span class="ml-1 text-[10px] font-mono opacity-80">↻</span></span>
                </div>
            </div>

            <!-- Detail panel -->
            <div id="llm-detail" class="mt-6 p-4 rounded border border-slate-600 bg-[#081f37]">
                <h3 class="font-semibold">Step • Auto progression</h3>
                <p id="llm-desc" class="text-sm mt-1 opacity-90">Waiting for question as a parameter…</p>
                <div class="mt-3 text-xs opacity-80">Question: <span id="llm-q">—</span></div>
            </div>

            <!-- Chat input & answer -->
            <div class="mt-4 p-4 rounded border border-slate-600 bg-[#081f37]">
                <div class="flex gap-2">
                    <input id="llm-input" class="flex-1 px-3 py-2 rounded bg-[#113f67] border border-slate-600"
                        placeholder="Ask a question…" />
                    <button id="llm-ask" class="px-3 py-2 rounded bg-[#00204a] text-white text-bold">Ask</button>
                </div>
                <div class="mt-3 text-sm">Answer: <span id="llm-answer">—</span></div>
            </div>
            <!--Footer section-->
            <footer class="bg-dark-card border-t border-slate-800/50 mt-40" id="contact">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-8">
                        <!-- Brand Info -->
                        <div class="col-span-2 md:col-span-1">
                            <a href="#" class="text-3xl font-extrabold text-white tracking-tight mb-4 block">
                                Apti<span class="text-neon-primary">Craft</span>
                            </a>
                            <p class="text-sm text-slate-500">
                                Automation meets creativity.
                            </p>
                        </div>

                        <!-- Links Column 1 -->
                        <div>
                            <h4 class="text-lg font-semibold text-white mb-4">Product</h4>
                            <ul class="space-y-3 text-sm">
                                <li><a href="#features" class="text-slate-400 hover:text-neon-primary">Features</a></li>
                                <li><a href="#responsive" class="text-slate-400 hover:text-neon-primary">Showcase</a>
                                </li>
                                <li><a href="#consistency" class="text-slate-400 hover:text-neon-primary">Value
                                        Promise</a></li>
                                <li><a href="#pricing" class="text-slate-400 hover:text-neon-primary">Pricing</a></li>
                                <li><a href="#" class="text-slate-400 hover:text-neon-primary">Integrations</a></li>
                            </ul>
                        </div>

                        <!-- Links Column 2 -->
                        <div>
                            <h4 class="text-lg font-semibold text-white mb-4">Company</h4>
                            <ul class="space-y-3 text-sm">
                                <li><a href="https://www.linkedin.com/in/afsanausa/"
                                        class="text-slate-400 hover:text-neon-primary">LinkedIn</a></li>
                                <li><a href="https://flask-apps-e45a.onrender.com/"
                                        class="text-slate-400 hover:text-neon-primary">Website</a></li>
                                <li><a href="https://github.com/Afsana721/flask_apps"
                                        class="text-slate-400 hover:text-neon-primary">GitHub</a></li>
                            </ul>
                        </div>
                    </div>

                    <!-- Copyright -->
                    <div class="mt-12 pt-8 border-t border-slate-800 text-center">
                        <p class="text-sm text-slate-500">
                            &copy; 2024 AptiCraft, Inc. All rights reserved.
                        </p>
                    </div>
                </div>
            </footer>

            <script>
                (function () {
                    const steps = document.querySelectorAll('#pipeline-grid > span');
                    const desc = document.getElementById('llm-desc');
                    const qEl = document.getElementById('llm-q');
                    const askBtn = document.getElementById('llm-ask');
                    const input = document.getElementById('llm-input');
                    const ansEl = document.getElementById('llm-answer');

                    // Tiny demo dataset (single line to avoid syntax errors)
                    const DATASET = [{
                        match: /current\s+high\s+level\s+job\s+condition\s+in\s+usa/i,
                        answer: "The current US high-level job situation is characterized by a slowing, yet stable, market where worker sentiment is declining despite low unemployment. Job openings have decreased compared to last year, and the pace of job growth has slowed."
                    }];
                    const getAnswer = q => {
                        const hit = DATASET.find(d => d.match.test(q));
                        return hit ? hit.answer : "Demo: generate answer from retrieved context.";
                    };

                    const info = [null,
                        { t: '1. AI (Agent)', d: 'Receives the question and coordinates next steps.' },
                        { t: '2. Ingest (Cleaner)', d: 'Extracts entities (time, topic, location).' },
                        { t: '3. Chunk (Cutter)', d: 'Splits cleaned text into overlapping pieces.' },
                        { t: '4. Embed (to numbers)', d: 'Converts each chunk to a semantic vector.' },
                        { t: '5. Index (Vector DB)', d: 'Builds/uses ANN index for fast lookup.' },
                        { t: '6. NLP (Listener)', d: 'Parses intent & slots; normalizes terms.' },
                        { t: '7. RAG (Retriever)', d: 'Fetches nearest relevant docs/chunks.' },
                        { t: '8. ToolPlan (Planner)', d: 'Chooses tools/queries & order.' },
                        { t: '9. Execute (Worker)', d: 'Runs tools/SQL/APIs for evidence.' },
                        { t: '10. ComposePrompt (Packager)', d: 'Packs question + context for LLM.' },
                        { t: '11. LLM (Writer)', d: 'Generates draft grounded answer.' },
                        { t: '12. Post-Process (Checker)', d: 'Refines, validates, formats.' },
                        { t: '13. Return (Messenger)', d: 'Shows result in the UI.' },
                        { t: '14. Learn Loop (Improver)', d: 'Logs feedback/telemetry for next time.' }
                    ];

                    function highlight(n) {
                        steps.forEach(s => s.classList.remove('ring', 'ring-indigo-400'));
                        const el = steps[n - 1];
                        if (el) { el.classList.add('ring', 'ring-indigo-400'); }
                    }
                    const delay = (ms) => new Promise(r => setTimeout(r, ms));

                    async function runPipeline(q) {
                        qEl.textContent = q;
                        ansEl.textContent = '…';
                        for (let i = 1; i <= 14; i++) {
                            highlight(i);
                            desc.textContent = info[i].d;
                            await delay(600);
                        }
                        const final = getAnswer(q);
                        ansEl.textContent = final;
                        desc.textContent = 'Done.';
                    }

                    askBtn.addEventListener('click', () => {
                        const q = (input.value || 'What is the current high level job condition in USA').trim();
                        input.value = '';
                        runPipeline(q);
                    });

                    // --- Minimal tests (console) ---
                    try {
                        console.assert(getAnswer('What is the current high level job condition in USA').startsWith('The current US high-level job situation'), 'Test: expected match failed');
                        console.assert(getAnswer('something else').includes('Demo:'), 'Test: expected demo fallback');
                    } catch (e) { console.warn('Tests failed:', e); }
                })();
            </script>
        </section>
        <!--LLM simulation with behind total process-->
    </div>


    <canvas id="three-canvas"></canvas>

    <script>
        // --- Global Variables (Background) ---
        let bgScene, bgCamera, bgRenderer, bgParticles;
        let bgWidth, bgHeight;

        // --- Global Variables (Farm Stack Visualization) ---
        let farmVizScene, farmVizCamera, farmVizRenderer, farmVizCore, farmVizInboundParticles, farmVizOutboundParticles;
        let farmVizWebDataCloud, farmVizSensorDataCloud, farmVizCognitiveDataCloud;
        const farmVizDataColors = {
            web: new THREE.Color(0x3b82f6), // Blue: Satellite Imagery
            sensor: new THREE.Color(0x22c55e), // Green: Soil/Climate Sensors
            cognitive: new THREE.Color(0xfacc15) // Yellow: ERP/Historical Data
        };


        // --- Data for Interactive Workflow ---
        const workflowSteps = {
            1: {
                title: "1.User Input: The Natural Language Command",
                description: "The farmer issues a conversational request, such as: **'How much water should I I use on Field 3 next week?'** This input is captured via a dashboard or voice interface and sent to the LLM for initial processing.",
                visualization: "<span class='text-4xl font-extrabold text-violet-400'>'Water Field 3'</span> <span class='text-gray-500'>-> LLM</span>"
            },
            2: {
                title: "2.Orchestration: LLM (The Brain)",
                description: "The Large Language Model acts as the orchestrator. It uses **tool-calling** to break down the request into a structured action plan, identifying key parameters (Field ID, Date Range) and delegating the task to the specialized Predictive Model.",
                visualization: "<span class='text-4xl font-extrabold text-violet-400'>LLM</span> <span class='text-gray-500'>parses request -> Calls Predictive Model (Field 3, Next Week)</span>"
            },
            3: {
                title: "3.Data Retrieval: RAG (The Memory)",
                description: "The Retrieval-Augmented Generation (RAG) tool queries the farm's central database (sensor history, ERP systems, external weather APIs). It fetches **only the most relevant, up-to-date data** (soil moisture, temperature forecasts, crop history) needed for the prediction.",
                visualization: "<span class='text-4xl font-extrabold text-violet-400'>RAG</span> <span class='text-gray-500'>fetches data from sensors & APIs:</span> <span class='text-sm font-mono text-emerald-400'> {Soil: 18%, Temp: 25C, Rainfall: 5mm}</span>"
            },
            4: {
                title: "4.Prediction & Planning: Specialized Models",
                description: "The specialized **Predictive Model** consumes the RAG-retrieved data. It calculates the precise output, determining that 30mm of water is required. The result is then sent back to the LLM for synthesis and validation against historical best practices.",
                visualization: "<span class='text-4xl font-extrabold text-violet-400'>Model</span> <span class='text-gray-500'>calculates:</span> <span class='text-4xl font-extrabold text-yellow-400'>Water = 30mm</span>"
            },
            5: {
                title: "5.Autonomous Execution: Edge & Robotics",
                description: "The LLM generates a final, human-readable response and simultaneously translates the 30mm command into a low-level **machine command packet**. This packet is sent over the Global Connectivity network for immediate execution by the farm's System & Circuitry and Robotics hardware.",
                visualization: "<span class='text-4xl font-extrabold text-violet-400'>Output</span> <span class='text-gray-500'>-> 'Apply 30mm' & Edge Command Packet -></span> <span class='text-4xl font-extrabold text-pink-400'>Tractor Actuation</span>"
            }
        };

        // --- Data for 14-Step Pipeline ---
        const pipelineStepsData = [
            { num: 1, name: "AI Agent", type: "object/function", desc: "Receives the question and coordinates next steps." },
            { num: 2, name: "Ingest Cleaner", type: "function", desc: "Cleans input, removes noise, fixes spacing, normalizes text." },
            { num: 3, name: "Chunk Cutter)", type: "object", desc: "Splits text into smaller readable pieces for better processing." },
            { num: 4, name: "Embed to numbers", type: "function", desc: "Turns chunks into numerical vectors the AI can understand." },
            { num: 5, name: "Index Vector DB", type: "object", desc: "Stores all embeddings for quick future look‑ups." },
            { num: 6, name: "NLP Listener", type: "function", desc: "Understands user intent, entities, and language meaning." },
            { num: 7, name: "RAG Retriever", type: "function", desc: "Finds matching data or context from the knowledge base." },
            { num: 8, name: "ToolPlan Planner", type: "function", desc: "Decides which tools or APIs are needed to solve the task." },
            { num: 9, name: "Execute Worker", type: "function", desc: "Runs the actual tool, query, or action based on the plan." },
            { num: 10, name: "ComposePrompt Packager", type: "function", desc: "Combines results and context into a single prompt for LLM." },
            { num: 11, name: "LLM Writer", type: "model", desc: "Generates the final human‑like response." },
            { num: 12, name: "PostProcess Checker", type: "function", desc: "Checks grammar, format, or filters sensitive info." },
            { num: 13, name: "Return Messenger", type: "object", desc: "Sends final output back to user interface." },
            { num: 14, name: "Learn Loop Improver", type: "object", desc: "Analyzes feedback to improve next responses." },
        ];

        // --- Pillar Interaction Functions (Kept for compatibility, though pillar cards are removed) ---

        function togglePillar(element) {
            const isActive = element.classList.contains('active');

            // Close all other pillars
            document.querySelectorAll('.pillar-card').forEach(card => {
                card.classList.remove('active');
            });

            // Toggle the clicked pillar
            if (!isActive) {
                element.classList.add('active');
            }
        }

        // --- Interactive Workflow Functions ---

        function showStep(stepNumber) {
            const step = workflowSteps[stepNumber];
            const contentDiv = document.getElementById('workflow-content');
            const buttons = document.querySelectorAll('.workflow-step-btn');

            // Update button styles
            buttons.forEach(btn => {
                if (parseInt(btn.getAttribute('data-step')) === stepNumber) {
                    btn.classList.add('active');
                    btn.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-violet-700', 'hover:text-white');
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-violet-700', 'hover:text-white');
                }
            });

            // Add fade-out effect
            contentDiv.classList.remove('fade-in');

            // Wait for the fade out to complete before updating content
            setTimeout(() => {
                contentDiv.innerHTML = `
                <h5 class="text-2xl font-bold text-white mb-4">${step.title}</h5>
                <p class="text-lg text-gray-300 mb-6">${step.description}</p>
                <div class="p-4 bg-gray-900 rounded-lg visualization-box text-center">
                    <p class="font-mono">${step.visualization}</p>
                </div>
            `;
                // Add fade-in effect for new content
                contentDiv.classList.add('fade-in');
            }, 200); // Matches the CSS transition time for opacity
        }

        // --- NEW: Pipeline Detail Functions ---

        function togglePipelineDetail(element) {
            element.classList.toggle('active');
        }

        function toggleAllPipelineDetails(shouldOpen) {
            document.querySelectorAll('.pipeline-card').forEach(card => {
                if (shouldOpen) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
        }

        function renderPipelineSteps() {
            const grid = document.getElementById('pipeline-grid');
            if (!grid) return;

            let html = '';
            pipelineStepsData.forEach(step => {
                html += `
                <div class="pipeline-card" onclick="togglePipelineDetail(this)">
                    <div class="flex items-center space-x-3">
                        <div class="pipeline-number text-teal-400">${step.num}.</div>
                        <div class="flex flex-col flex-grow">
                            <span class="pipeline-name">${step.name}</span>
                        </div>
                        <span class="pipeline-type">${step.type}</span>
                    </div>
                    <div class="pipeline-detail">
                        <p class="text-sm mt-1">${step.desc}</p>
                    </div>
                </div>
            `;
            });
            grid.innerHTML = html;
        }


        // --- Background 3D Functions (Existing Logic) ---

        function initBackground() {
            const canvas = document.getElementById('three-canvas');
            bgWidth = window.innerWidth;
            bgHeight = window.innerHeight;

            // 1. Scene Setup
            bgScene = new THREE.Scene();

            // 2. Camera Setup
            bgCamera = new THREE.PerspectiveCamera(75, bgWidth / bgHeight, 0.1, 1000);
            bgCamera.position.z = 100;

            // 3. Renderer Setup
            bgRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            bgRenderer.setSize(bgWidth, bgHeight);

            // 4. Particle System (Purple and Blue Hues for background)
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];

            const color = new THREE.Color();
            const material = new THREE.PointsMaterial({
                size: 0.2,
                sizeAttenuation: true,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            for (let i = 0; i < 300; i++) { // Slightly more particles
                positions.push(
                    (Math.random() - 0.5) * 250,
                    (Math.random() - 0.5) * 250,
                    (Math.random() - 0.5) * 250
                );

                // Randomly choose between violet and electric blue
                if (Math.random() > 0.5) {
                    color.setHSL(0.75 + (Math.random() * 0.1 - 0.05), 0.9, 0.6 + (Math.random() * 0.2)); // Violet
                } else {
                    color.setHSL(0.55 + (Math.random() * 0.1 - 0.05), 0.9, 0.6 + (Math.random() * 0.2)); // Electric Blue
                }
                colors.push(color.r, color.g, color.b);
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            bgParticles = new THREE.Points(geometry, material);
            bgScene.add(bgParticles);

            window.addEventListener('resize', onBackgroundWindowResize, false);
        }

        function onBackgroundWindowResize() {
            bgWidth = window.innerWidth;
            bgHeight = window.innerHeight;
            if (bgCamera) {
                bgCamera.aspect = bgWidth / bgHeight;
                bgCamera.updateProjectionMatrix();
            }
            if (bgRenderer) {
                bgRenderer.setSize(bgWidth, bgHeight);
            }
        }

        function animateBackground() {
            const time = Date.now() * 0.0001;
            bgParticles.rotation.y = time * 0.1;
            bgParticles.rotation.z = time * 0.05;
            bgRenderer.render(bgScene, bgCamera);

            // Subtle movement for particles
            const positions = bgParticles.geometry.attributes.position.array;
            for (let i = 2; i < positions.length; i += 3) {
                positions[i] += 0.05; // Move particles slowly towards the camera
                if (positions[i] > 125) {
                    positions[i] = -125; // Loop back when they get too close
                }
            }
            bgParticles.geometry.attributes.position.needsUpdate = true;
        }

        // --- Farm Stack Visualization Functions (NEW LOGIC) ---
        function createDataCloud(color, count, range, positionOffset) {
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            for (let i = 0; i < count; i++) {
                positions.push(
                    (Math.random() - 0.5) * range.x,
                    (Math.random() - 0.5) * range.y,
                    (Math.random() - 0.5) * range.z
                );
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            const material = new THREE.PointsMaterial({
                color: color,
                size: 0.6,
                transparent: true,
                opacity: 0.8
            });
            const cloud = new THREE.Points(geometry, material);
            cloud.position.set(positionOffset.x, positionOffset.y, positionOffset.z);
            return cloud;
        }

        function resetInboundParticle(index) {
            const positions = farmVizInboundParticles.geometry.attributes.position.array;
            const colors = farmVizInboundParticles.geometry.attributes.color.array;

            const sourceChoice = Math.random();
            let sourceCloud, sourceColor;

            if (sourceChoice < 0.33) {
                sourceCloud = farmVizWebDataCloud;
                sourceColor = farmVizDataColors.web;
            } else if (sourceChoice < 0.66) {
                sourceCloud = farmVizSensorDataCloud;
                sourceColor = farmVizDataColors.sensor;
            } else {
                sourceCloud = farmVizCognitiveDataCloud;
                sourceColor = farmVizDataColors.cognitive;
            }

            const cloudPositions = sourceCloud.geometry.attributes.position.array;
            const randomIndex = Math.floor(Math.random() * (cloudPositions.length / 3)) * 3;

            positions[index] = cloudPositions[randomIndex] + sourceCloud.position.x;
            positions[index + 1] = cloudPositions[randomIndex + 1] + sourceCloud.position.y;
            positions[index + 2] = cloudPositions[randomIndex + 2] + sourceCloud.position.z;

            colors[index] = sourceColor.r;
            colors[index + 1] = sourceColor.g;
            colors[index + 2] = sourceColor.b;
        }

        function onFarmStackVizWindowResize() {
            const container = document.getElementById('canvas-container');
            if (!container || container.clientWidth === 0 || container.clientHeight === 0) return; // Prevent division by zero
            farmVizCamera.aspect = container.clientWidth / container.clientHeight;
            farmVizCamera.updateProjectionMatrix();
            farmVizRenderer.setSize(container.clientWidth, container.clientHeight);
        }

        function initFarmStackViz() {
            const container = document.getElementById('canvas-container');
            if (!container) {
                console.error("Canvas container not found for visualization!");
                return;
            }

            // Scene
            farmVizScene = new THREE.Scene();

            // Camera
            farmVizCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            farmVizCamera.position.z = 120;

            // Renderer
            farmVizRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            farmVizRenderer.setSize(container.clientWidth, container.clientHeight);
            farmVizRenderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(farmVizRenderer.domElement);

            // Light
            const ambientLight = new THREE.AmbientLight(0x404040, 5); // soft white light
            farmVizScene.add(ambientLight);

            // 1. LLM Processing Core
            const coreGeometry = new THREE.IcosahedronGeometry(15, 2);
            const coreMaterial = new THREE.MeshBasicMaterial({
                color: 0x8b5cf6, // purple-500
                wireframe: true
            });
            farmVizCore = new THREE.Mesh(coreGeometry, coreMaterial);
            farmVizScene.add(farmVizCore);

            // 2. Data Source Clouds (Positions relative to labels)
            farmVizWebDataCloud = createDataCloud(farmVizDataColors.web, 1500, { x: 150, y: 150, z: 150 }, { x: -150, y: 80, z: -50 });
            farmVizScene.add(farmVizWebDataCloud);

            farmVizSensorDataCloud = createDataCloud(farmVizDataColors.sensor, 1500, { x: 150, y: 150, z: 150 }, { x: 150, y: 50, z: -30 });
            farmVizScene.add(farmVizSensorDataCloud);

            farmVizCognitiveDataCloud = createDataCloud(farmVizDataColors.cognitive, 1500, { x: 150, y: 150, z: 150 }, { x: -100, y: -120, z: 0 });
            farmVizScene.add(farmVizCognitiveDataCloud);

            // 3. Inbound Data Stream
            const inboundGeometry = new THREE.BufferGeometry();
            const inboundPositions = [];
            const inboundColors = [];
            for (let i = 0; i < 1500; i++) {
                inboundPositions.push(0, 0, 0);
                inboundColors.push(1, 1, 1);
            }
            inboundGeometry.setAttribute('position', new THREE.Float32BufferAttribute(inboundPositions, 3));
            inboundGeometry.setAttribute('color', new THREE.Float32BufferAttribute(inboundColors, 3));
            const inboundMaterial = new THREE.PointsMaterial({
                size: 0.8,
                vertexColors: true
            });
            farmVizInboundParticles = new THREE.Points(inboundGeometry, inboundMaterial);
            for (let i = 0; i < farmVizInboundParticles.geometry.attributes.position.array.length; i += 3) {
                resetInboundParticle(i);
            }
            farmVizScene.add(farmVizInboundParticles);

            // 4. Outbound Data Stream
            const outboundGeometry = new THREE.BufferGeometry();
            const outboundPositions = [];
            const velocities = [];
            for (let i = 0; i < 500; i++) {
                outboundPositions.push(0, 0, 0);
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos((Math.random() * 2) - 1);
                velocities.push(
                    Math.sin(phi) * Math.cos(theta),
                    Math.sin(phi) * Math.sin(theta),
                    Math.cos(phi)
                );
            }
            outboundGeometry.setAttribute('position', new THREE.Float32BufferAttribute(outboundPositions, 3));
            outboundGeometry.setAttribute('velocity', new THREE.Float32BufferAttribute(velocities, 3));
            const outboundMaterial = new THREE.PointsMaterial({ color: 0xa855f7, size: 0.8 });
            farmVizOutboundParticles = new THREE.Points(outboundGeometry, outboundMaterial);
            farmVizScene.add(farmVizOutboundParticles);

            // Event Listeners for Farm Stack Visualization
            window.addEventListener('resize', onFarmStackVizWindowResize, false);

            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            farmVizRenderer.domElement.addEventListener('mousedown', (e) => {
                isDragging = true;
            });

            farmVizRenderer.domElement.addEventListener('mouseup', (e) => {
                isDragging = false;
            });

            farmVizRenderer.domElement.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - previousMousePosition.x;
                    const deltaY = e.clientY - previousMousePosition.y;

                    farmVizCore.rotation.y += deltaX * 0.005;
                    farmVizCore.rotation.x += deltaY * 0.005;
                }
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
        }

        function animateFarmStackViz() {
            if (!farmVizRenderer) return;

            // 1. Rotate the Core
            farmVizCore.rotation.x += 0.001;
            farmVizCore.rotation.y += 0.002;

            // 2. Rotate Data Clouds
            farmVizWebDataCloud.rotation.y += 0.001;
            farmVizSensorDataCloud.rotation.y -= 0.001;
            farmVizCognitiveDataCloud.rotation.x += 0.001;

            // 3. Animate Inbound Particles moving towards the core
            const inPositions = farmVizInboundParticles.geometry.attributes.position.array;
            for (let i = 0; i < inPositions.length; i += 3) {
                const vec = new THREE.Vector3(inPositions[i], inPositions[i + 1], inPositions[i + 2]);
                vec.lerp(new THREE.Vector3(0, 0, 0), 0.015); // Move towards center
                inPositions[i] = vec.x;
                inPositions[i + 1] = vec.y;
                inPositions[i + 2] = vec.z;

                // Reset if it gets too close
                if (vec.length() < 10) {
                    resetInboundParticle(i);
                }
            }
            farmVizInboundParticles.geometry.attributes.position.needsUpdate = true;
            farmVizInboundParticles.geometry.attributes.color.needsUpdate = true;

            // 4. Animate Outbound Particles moving away from the core
            const outPositions = farmVizOutboundParticles.geometry.attributes.position.array;
            const velocities = farmVizOutboundParticles.geometry.attributes.velocity.array;
            for (let i = 0; i < outPositions.length; i += 3) {
                outPositions[i] += velocities[i] * 0.5;
                outPositions[i + 1] += velocities[i + 1] * 0.5;
                outPositions[i + 2] += velocities[i + 2] * 0.5;

                const dist = Math.sqrt(outPositions[i] ** 2 + outPositions[i + 1] ** 2 + outPositions[i + 2] ** 2);
                if (dist > 180) {
                    outPositions[i] = 0;
                    outPositions[i + 1] = 0;
                    outPositions[i + 2] = 0;
                }
            }
            farmVizOutboundParticles.geometry.attributes.position.needsUpdate = true;

            farmVizRenderer.render(farmVizScene, farmVizCamera);
        }

        // --- Combined Animation Loop ---

        function animate() {
            requestAnimationFrame(animate);

            // Run background animation
            if (bgRenderer) {
                animateBackground();
            }

            // Run Farm Stack Visualization animation
            if (farmVizRenderer) {
                animateFarmStackViz();
            }
        }

        window.onload = function () {
            // Initialize background
            initBackground();

            // Initialize Farm Stack Visualization
            initFarmStackViz();

            // Start combined animation loop
            animate();

            // Show the first step of the interactive workflow on load
            showStep(1);

            // Render the new pipeline steps
            renderPipelineSteps();
        }
    </script>
</body>
</html>
